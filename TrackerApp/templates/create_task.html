{% extends "base.html" %}
{% block content %}

<div class="card-container">
  <form class="form-group panel" method="POST">
    <h1 class="h3 mb-3 fw-normal">Maintain Task</h1>
     {{ form.hidden_tag() }}
     <div class="form-group">
      <label class="form-label">Job</label>
      <input type="text" class="form-control" value="{{ job_name }}" disabled readonly> 
     </div>
     <div class="form-group">
     {{ form.name.label(class="form-label") }}
     {{ form.name(class="form-control  ") }}  
     </div>
     {% if update %}
      <label class="form-label">Address</label>
      <textarea class="form-control" name="address" id="address" readonly>{{ task_address }}</textarea> 
     {% else %}
      {{ form.address(class="d-none") }}
     {% endif %}
     
     <div class="form-group">
     {{ form.note.label(class="form-label") }}
     {{ form.note(class="form-control ") }}
     </div>
     <div class="form-group">
        {{ form.status.label(class="form-label") }}
        {{ form.status(class="form-control  ") }}
     </div>
     <div class="form-group">
        {{ form.order.label(class="form-label") }}
        {{ form.order(class="form-control") }}
     </div>
     {{ form.lon_lat(class="d-none") }}
     <br>
     <br>
     <br>
     
     <div class="form-group">
         {{ form.submit(class="btn btn-primary") }}
      
         {% if update %}
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#del_modal2">Delete</button>
         {% endif %} 
      </div>
    </form>
    <div class="form-group">
      <br>
      <label class="form-label">Select Address</label>
      <input class="form-control" type="text" id="address_select"/>
      <br>
      <div class="map"  id="map"></div>
    </div>


    
</div> 


{% if update %}
<div class="modal" tabindex="-1" id="del_modal2">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this Task and all its related Status and History?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <form action="{{ url_for('tasks.delete_task', job_id=job_id, task_id=task_id) }}" method="POST">
          <input class="btn btn-danger" type="submit" value="Delete">
        </form>

      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  "use strict";
  function initMap() {
    
    const myCenter = {{ map_center }};

    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: myCenter,
      mapTypeControl: false,
      fullscreenControl: true,
      zoomControl: true,
      streetViewControl: true
    });

    const marker = new google.maps.Marker({map: map, position: myCenter, draggable: false});
  
    const autocompleteInput = document.getElementById('address_select');
    
    const autocomplete = new google.maps.places.Autocomplete(autocompleteInput, {
      fields: ["address_components", "geometry", "name"],
      types: ["address"],
    });

    autocomplete.addListener('place_changed', function () {
      marker.setVisible(false);
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        // User entered the name of a Place that was not suggested and
        // pressed the Enter key, or the Place Details request failed.
        window.alert('No details available for input: \'' + place.name + '\'');
        return;
      }
      renderAddress(place);
      document.getElementById('address').value = document.getElementById('address_select').value;
      document.getElementById('lon_lat').value = place.geometry.location;
    });
    

    function renderAddress(place) {
      map.setCenter(place.geometry.location);
      marker.setPosition(place.geometry.location);
      marker.setVisible(true); 
    };
  }
  </script>
<script
src="https://maps.googleapis.com/maps/api/js?key={{config['GOOGLEMAPS_KEY']}}&libraries=places&callback=initMap&channel=GMPSB_addressselection_v1_cABC&region=ZA" async defer>
</script>

{% endblock content %}
  
